# .github/workflows/rss-collect.yml
name: ğŸš— Toyota RSS Collection

on:
  # å®šæœŸå®Ÿè¡Œ: 4æ™‚é–“æ¯ï¼ˆJST: 1æ™‚, 5æ™‚, 9æ™‚, 13æ™‚, 17æ™‚, 21æ™‚ï¼‰
  schedule:
    - cron: '0 */4 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'normal'
        type: choice
        options:
        - normal
        - test
        - debug

env:
  # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ—¥æœ¬æ™‚é–“ã«è¨­å®š
  TZ: Asia/Tokyo

jobs:
  collect-toyota-rss:
    name: ğŸ“° Toyota RSS ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“‚ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js 18 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        echo "ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        npm ci
        echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
        
    - name: ğŸ”‘ Firebaseèªè¨¼æƒ…å ±ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—  
      run: |
        echo "ğŸ”‘ Firebaseèªè¨¼æƒ…å ±ã‚’è¨­å®šä¸­..."
        cat > firebase-key.json << 'EOF'
        {
          "type": "service_account",
          "project_id": "${{ secrets.FIREBASE_PROJECT_ID }}",
          "private_key_id": "github-actions-key",
          "private_key": "${{ secrets.FIREBASE_PRIVATE_KEY }}",
          "client_email": "${{ secrets.FIREBASE_CLIENT_EMAIL }}",
          "client_id": "github-actions-client",
          "auth_uri": "https://accounts.google.com/o/oauth2/auth",
          "token_uri": "https://oauth2.googleapis.com/token",
          "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs"
        }
        EOF
        echo "âœ… Firebaseèªè¨¼æƒ…å ±ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
        
    - name: ğŸ“ ç’°å¢ƒå¤‰æ•°è¨­å®š
      run: |
        echo "ğŸ“ ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šä¸­..."
        echo "GOOGLE_APPLICATION_CREDENTIALS=./firebase-key.json" > .env
        echo "FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
        echo "âœ… ç’°å¢ƒå¤‰æ•°è¨­å®šå®Œäº†"
        
    - name: ğŸ” è¨­å®šç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰
      if: github.event.inputs.execution_mode == 'debug'
      run: |
        echo "ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
        echo "Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(node --version)"
        echo "npm ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(npm --version)"
        echo "ç¾åœ¨æ™‚åˆ» (UTC): $(date -u)"
        echo "ç¾åœ¨æ™‚åˆ» (JST): $(TZ=Asia/Tokyo date)"
        echo "ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
        echo "ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
        ls -la
        echo "package.json ã®å†…å®¹ç¢ºèª:"
        if [ -f package.json ]; then
          cat package.json
        else
          echo "âŒ package.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi
        
    - name: ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
      if: github.event.inputs.execution_mode == 'test'
      run: |
        echo "ğŸ§ª Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        node test-connection.js
        
    - name: ğŸš€ Toyota RSSåé›†å®Ÿè¡Œ
      id: rss_collection
      run: |
        echo "ğŸš€ Toyota RSSåé›†ã‚’é–‹å§‹ã—ã¾ã™..."
        echo "â° å®Ÿè¡Œé–‹å§‹æ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
        echo "ğŸŒ å®Ÿè¡Œç’°å¢ƒ: GitHub Actions (ubuntu-latest)"
        echo ""
        
        # RSSåé›†å®Ÿè¡Œ
        node rss-collector.js
        
        echo ""
        echo "âœ… RSSåé›†ãŒå®Œäº†ã—ã¾ã—ãŸ"
        echo "â° å®Ÿè¡Œå®Œäº†æ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
        
    - name: ğŸ“Š å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼
      if: always()
      run: |
        echo "ğŸ“Š ===== å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼ ====="
        echo "ğŸ•’ å®Ÿè¡Œæ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
        echo "âš™ï¸ å®Ÿè¡Œç’°å¢ƒ: GitHub Actions"
        echo "ğŸ¯ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.execution_mode || 'scheduled' }}"
        if [ "${{ steps.rss_collection.outcome }}" = "success" ]; then
          echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æˆåŠŸ"
        else
          echo "âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¤±æ•—"
        fi
        echo "ğŸ”— è©³ç´°ãƒ­ã‚°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "=========================="
        
    - name: ğŸ§¹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      if: always()
      run: |
        echo "ğŸ§¹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
        # èªè¨¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«å‰Šé™¤
        rm -f firebase-key.json
        rm -f .env
        echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
        
    - name: âŒ å¤±æ•—æ™‚ã®è©³ç´°æƒ…å ±
      if: failure()
      run: |
        echo "âŒ å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°æƒ…å ±:"
        echo "ğŸ•’ å¤±æ•—æ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
        echo "ğŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ç¢ºèª:"
        if [ -f npm-debug.log ]; then
          echo "=== npm-debug.log ==="
          cat npm-debug.log
        fi
        echo "ğŸ“ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
        find . -type f -name "*.js" -o -name "*.json" | head -20